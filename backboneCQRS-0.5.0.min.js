//     Backbone.CQRS.js
//     (c) 2012 Jan MÃ¼hlemann
//     Backbone.CQRS may be freely distributed under the MIT license.

((function(){var a=this,b=a.Backbone;b.CQRS={};var c=a._,d=a.jQuery||a.Zepto,e=d.noop;b.CQRS.Message=b.Model.extend({url:e,fetch:e,save:e,destroy:e});var f=b.CQRS.Message.extend({});b.CQRS.Command=b.CQRS.Message.extend({emit:function(a){a&&this.observe(a),b.CQRS.hub.emit(b.CQRS.hub.commandsChannel,this.parse(this.toJSON()))},parse:function(a){return a},observe:function(a){b.CQRS.eventHandler.observe(this.id,a)}});var g=b.CQRS.hub={commandsChannel:"commands",defaults:{commandsChannel:"commands",eventsChannel:"events",eventNameAttr:"name",eventModelIdAttr:"payload.id",eventResponseToCommandId:"commandId"},init:function(a){var b=this;this.initialized||(this.initialized=!0,a=c.extend(this.defaults,a),a.parseEvent&&(this.parseEvent=a.parseEvent),a.getCommandId&&(this.getCommandId=a.getCommandId),this.commandsChannel=a.commandsChannel,this.on(a.eventsChannel,function(c){var d=new f;d.set(this.parseEvent(c));var e=d.toJSON();d.name=j(e,a.eventNameAttr),d.id=j(e,a.eventModelIdAttr),d.cmdId=b.getCommandId(e,a.eventResponseToCommandId),this.emit("dispatchEvent",d)}))},parseEvent:function(a){var b=a;return typeof b=="string"&&(b=JSON.parse(b)),b},getCommandId:function(a,b){return j(a,b)}};c.extend(g,b.Events),g.on=g.bind,g.emit=g.trigger,b.CQRS.EventDenormalizer=function(a){a=a||{},a.forEvent&&(this.forEvent=a.forEvent),a.forModel&&(this.forModel=a.forModel),this.methode=a.methode||"update",this.model=a.model,this.collection=a.collection,this.forEvent&&this.forModel&&this.register.apply(this),this.initialize.apply(this,arguments)},c.extend(b.CQRS.EventDenormalizer.prototype,b.Events,{defaultPayloadValue:"payload",initialize:e,handle:function(a){if(this.methode!=="create")a.id&&this.trigger("change:"+a.id,this.parse(a),this.apply(this.methode));else{var b=new this.model(this.parse(a)),c=typeof this.collection=="function"?this.collection():this.collection;c&&c.add(b)}},apply:function(a){return function(b,c){a==="delete"?(c.isCQRSBound&&c.unbindCQRS(),c.destroy()):c.set(b)}},parse:function(a){return this.defaultPayloadValue?j(a.toJSON(),this.defaultPayloadValue):a.toJSON()},register:function(a,c){this.forEvent=a||this.forEvent,this.forModel=c||this.forModel,b.CQRS.eventHandler.register(this)}}),b.CQRS.EventDenormalizer.extend=b.Model.extend;var h=b.CQRS.EventDenormalizer.extend({initialize:function(){this.denormalizers=[],this.observedCommands=[],b.CQRS.hub.on("dispatchEvent",function(a){this.handle(a)},this)},getDenormalizer:function(a,b){return a?c(this.denormalizers).filter(function(b){return b.forEvent==a}):b?c(this.denormalizers).filter(function(a){return a.forModel==b}):null},handle:function(a){var b=this.getPendingCommand(a);b&&(b.callback(a),this.removePendingCommand(b));var d=this.getDenormalizer(a.name);c(d).each(function(b){b.handle(a)})},bind:function(a,b,d){if(a.indexOf(":")<0)return!1;var e=a.substring(0,a.indexOf(":")),f="change:"+a.substring(a.indexOf(":")+1,a.length),g=this.getDenormalizer(null,e);c(g).each(function(a){a.bind(f,b,d)})},unbind:function(a,b){if(a.indexOf(":")<0)return!1;var d=a.split(":"),e=d[0],f="change:"+d[1],g=this.getDenormalizer(null,e);c(g).each(function(a){a.unbind(f,b)})},observe:function(a,b){this.observedCommands.push({id:a,callback:b})},getPendingCommand:function(a){return c.detect(this.observedCommands,function(b){return b.id==a.cmdId})},removePendingCommand:function(a){var b=c.indexOf(this.observedCommands,a);this.observedCommands.splice(b,1)},register:function(a){this.denormalizers.push(a)}});b.CQRS.eventHandler=new h,b.Model=b.Model.extend({modelName:null,bindCQRS:function(a){a&&(this.modelName=a);if(!this.modelName)return;var c=this.id||this.cid;b.CQRS.eventHandler.bind(this.modelName+":"+c,this.apply,this),this.isCQRSBound=!0},unbindCQRS:function(a){a&&(this.modelName=a);if(!this.modelName)return;var c=this.id||this.cid;b.CQRS.eventHandler.unbind(this.modelName+":"+c,this.apply,this),this.isCQRSBound=!1},apply:function(a,b){b.apply(this,[a,this])}});var i=b.sync;b.CQRS.sync=function(a,b,c){var d=k[a];if(d!=="GET")return c.success();i(a,b,c)};var j=function(a,b){var c=b.split("."),d=0,e=a;while(c[d])e=e&&e[c[d]],d++;return e},k={create:"POST",update:"PUT","delete":"DELETE",read:"GET"}})).call(this)